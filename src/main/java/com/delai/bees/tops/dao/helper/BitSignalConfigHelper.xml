<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.delai.bees.tops.dao.BitSignalConfigMapper">

  <resultMap id="BitAnalogSignalsStatsBaseResultMap" type="com.delai.bees.tops.entity.domain.BitAnalogSignalsStats">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Mar 08 11:07:28 CST 2019.
    -->
    <result column="Key" jdbcType="VARCHAR" property="key" />
    <result column="Remark" jdbcType="VARCHAR" property="remark" />
    <result column="Address" jdbcType="VARCHAR" property="address" />
    <result column="Begin" jdbcType="TIMESTAMP" property="begin" />
    <result column="End" jdbcType="TIMESTAMP" property="end" />
    <result column="Count" jdbcType="INTEGER" property="count" />
    <result column="Duration" jdbcType="INTEGER" property="duration" />
  </resultMap>


  <delete id="clear">
    DELETE FROM Bit_Signal_Config
  </delete>

  <select id="statsTopsBitAnalogSignalsAccordingTimeRange" resultMap="BitAnalogSignalsStatsBaseResultMap">
    SELECT
      A.`Key` AS `Key`,
      A.`Remark` AS `Remark`,
      A.`Address` AS `Address`,
      MIN(B.Ts) AS `Begin`,
      MAX(B.Ts) AS `End`,
      COUNT(1) AS `Count`,
      COUNT(1) * 5 AS `Duration`
    FROM Bit_Signal_Config A
      LEFT JOIN Bit_Analog_Signals B
        ON (A.`Address` = B.`Name` AND A.Val &amp; B.Val )
    WHERE 1 = 1 AND LENGTH(A.Address) > 0 AND LENGTH(A.`Key`) > 0
      AND B.`Ts` BETWEEN #{begin, jdbcType=TIMESTAMP} AND #{end, jdbcType=TIMESTAMP}
      AND A.`Enable` = 1
    GROUP BY A.`Key`
    ORDER BY `Count` DESC
  </select>


</mapper>